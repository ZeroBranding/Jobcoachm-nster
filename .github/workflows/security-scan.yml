name: Security Scan

on:
  schedule:
    # LÃ¤uft tÃ¤glich um 2:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '**.js'
      - '**.html'
      - '**.css'
      - 'package*.json'

env:
  NODE_VERSION: '18'

jobs:
  # =============================================================================
  # DEPENDENCY VULNERABILITY SCAN
  # =============================================================================
  dependency-scan:
    name: ğŸ“¦ Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ”’ NPM Security Audit
        run: |
          echo "ğŸ” Running npm audit..."
          npm audit --audit-level=high --json > npm-audit.json || true
          
          # Check for high/critical vulnerabilities
          if npm audit --audit-level=high; then
            echo "âœ… No high/critical vulnerabilities found"
          else
            echo "âŒ High/critical vulnerabilities detected!"
            npm audit --audit-level=high
            exit 1
          fi
          
      - name: ğŸ” Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
          
      - name: ğŸ“Š Upload Vulnerability Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerability-report
          path: |
            npm-audit.json
            snyk-report.json

  # =============================================================================
  # CODE SECURITY ANALYSIS
  # =============================================================================
  code-security:
    name: ğŸ” Code Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ” CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          
      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3
        
      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        
      - name: ğŸ”’ Semgrep Security Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/javascript
            p/owasp-top-ten
            p/xss
          generateSarif: "1"
          
      - name: ğŸ“Š Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        if: always()

  # =============================================================================
  # WEB APPLICATION SECURITY TEST
  # =============================================================================
  web-security:
    name: ğŸŒ Web Application Security Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸŒ Start Test Server
        run: |
          npm run dev &
          sleep 10
          
      - name: ğŸ›¡ï¸ OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.8.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          
      - name: ğŸ” Nuclei Security Scan
        uses: projectdiscovery/nuclei-action@main
        with:
          target: 'http://localhost:8080'
          templates: 'exposures,vulnerabilities'
          
      - name: ğŸ“Š Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: web-security-reports
          path: |
            zap-report.html
            nuclei-report.json

  # =============================================================================
  # SSL/TLS SECURITY CHECK
  # =============================================================================
  ssl-check:
    name: ğŸ” SSL/TLS Security Check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ” SSL Labs Test
        run: |
          # Nur fÃ¼r Live-Domains
          if [[ -n "${{ secrets.PRODUCTION_DOMAIN }}" ]]; then
            echo "ğŸ” Testing SSL configuration for: ${{ secrets.PRODUCTION_DOMAIN }}"
            
            # SSL Labs API Test (vereinfacht)
            curl -s "https://api.ssllabs.com/api/v3/analyze?host=${{ secrets.PRODUCTION_DOMAIN }}&publish=off&startNew=on" > ssl-test.json
            
            # Warte auf Test-Completion (vereinfacht)
            sleep 60
            
            # Hole Ergebnisse
            curl -s "https://api.ssllabs.com/api/v3/analyze?host=${{ secrets.PRODUCTION_DOMAIN }}" > ssl-results.json
            
            # PrÃ¼fe Grade (A oder besser)
            grade=$(cat ssl-results.json | jq -r '.endpoints[0].grade // "PENDING"')
            
            if [[ "$grade" =~ ^A ]]; then
              echo "âœ… SSL Grade: $grade"
            else
              echo "âŒ SSL Grade insufficient: $grade"
              exit 1
            fi
          else
            echo "â„¹ï¸ No production domain configured, skipping SSL test"
          fi
          
      - name: ğŸ”’ Security Headers Test
        run: |
          if [[ -n "${{ secrets.PRODUCTION_URL }}" ]]; then
            echo "ğŸ” Testing security headers..."
            
            # Test wichtige Security Headers
            headers=(
              "Content-Security-Policy"
              "Strict-Transport-Security"
              "X-Frame-Options"
              "X-Content-Type-Options"
              "Referrer-Policy"
            )
            
            for header in "${headers[@]}"; do
              if curl -s -I "${{ secrets.PRODUCTION_URL }}" | grep -i "$header"; then
                echo "âœ… $header header found"
              else
                echo "âŒ $header header missing"
                exit 1
              fi
            done
          fi

  # =============================================================================
  # COMPLIANCE MONITORING
  # =============================================================================
  compliance-check:
    name: âš–ï¸ Compliance Monitoring
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: âš–ï¸ GDPR Compliance Check
        run: |
          echo "ğŸ” Checking GDPR compliance..."
          
          # PrÃ¼fe Cookie-Banner Implementation
          if grep -r "cookie.*consent\|consent.*cookie" . --include="*.html" --include="*.js"; then
            echo "âœ… Cookie consent implementation found"
          else
            echo "âŒ Cookie consent implementation missing"
            exit 1
          fi
          
          # PrÃ¼fe DatenschutzerklÃ¤rung
          if [[ -f "legal/datenschutz.template.md" ]]; then
            echo "âœ… Privacy policy found"
          else
            echo "âŒ Privacy policy missing"
            exit 1
          fi
          
      - name: â™¿ Accessibility Compliance
        run: |
          echo "ğŸ” Checking accessibility compliance..."
          
          # PrÃ¼fe WCAG 2.2 AA Implementation
          if grep -r "aria-\|role=\|alt=" . --include="*.html"; then
            echo "âœ… Accessibility attributes found"
          else
            echo "âŒ Accessibility attributes missing"
            exit 1
          fi

  # =============================================================================
  # MONITORING SETUP
  # =============================================================================
  setup-monitoring:
    name: ğŸ“Š Setup Monitoring
    runs-on: ubuntu-latest
    needs: [deploy-vercel]
    if: always() && needs.deploy-vercel.result == 'success'
    
    steps:
      - name: ğŸ“Š Setup Uptime Monitoring
        run: |
          # Beispiel fÃ¼r UptimeRobot API
          if [[ -n "${{ secrets.UPTIMEROBOT_API_KEY }}" ]]; then
            curl -X POST "https://api.uptimerobot.com/v2/newMonitor" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "api_key=${{ secrets.UPTIMEROBOT_API_KEY }}" \
              -d "format=json" \
              -d "type=1" \
              -d "url=${{ secrets.PRODUCTION_URL }}" \
              -d "friendly_name=JobCoach MÃ¼nster - Main"
          fi
          
      - name: ğŸš¨ Setup Error Monitoring
        run: |
          echo "ğŸ“Š Monitoring setup completed"
          echo "ğŸŒ Site: ${{ secrets.PRODUCTION_URL }}"
          echo "ğŸ“ˆ Monitor: Active"

  # =============================================================================
  # DEPLOYMENT SUMMARY
  # =============================================================================
  deployment-summary:
    name: ğŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [docker-build, deploy-vercel, ssl-check, compliance-check, post-deploy-tests]
    if: always()
    
    steps:
      - name: ğŸ“‹ Generate Summary
        run: |
          echo "## ğŸš€ Deployment Summary"
          echo "**Branch:** ${{ github.ref_name }}"
          echo "**Commit:** ${{ github.sha }}"
          echo "**Triggered by:** ${{ github.actor }}"
          echo ""
          echo "### ğŸ“Š Results:"
          echo "- Docker Build: ${{ needs.docker-build.result }}"
          echo "- Vercel Deploy: ${{ needs.deploy-vercel.result }}"
          echo "- SSL Check: ${{ needs.ssl-check.result }}"
          echo "- Compliance: ${{ needs.compliance-check.result }}"
          echo "- Post-Deploy Tests: ${{ needs.post-deploy-tests.result }}"
          echo ""
          if [[ "${{ needs.deploy-vercel.result }}" == "success" ]]; then
            echo "ğŸ‰ **Deployment erfolgreich!**"
            echo "ğŸŒ Live unter: ${{ secrets.PRODUCTION_URL || 'https://jobcoach-muenster.vercel.app' }}"
          else
            echo "âŒ **Deployment fehlgeschlagen!**"
            echo "Bitte Logs Ã¼berprÃ¼fen."
          fi