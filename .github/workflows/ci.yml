name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'

jobs:
  # =============================================================================
  # CODE QUALITY & LINTING
  # =============================================================================
  lint:
    name: ğŸ” Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ” HTML Validation
        run: |
          npm install -g html-validate
          html-validate index.html leichte-sprache.html leicht.html
          
      - name: ğŸ¨ CSS Validation
        run: |
          npm install -g css-validator
          css-validator assets/app.css
          
      - name: ğŸ“ JavaScript Linting
        run: |
          npm install -g eslint
          npx eslint assets/*.js --ext .js
          
      - name: ğŸ”’ Security Audit
        run: npm audit --audit-level=high

  # =============================================================================
  # ACCESSIBILITY TESTS
  # =============================================================================
  accessibility:
    name: â™¿ Accessibility Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps
        
      - name: ğŸŒ Start Test Server
        run: |
          npm run dev &
          sleep 10
          
      - name: â™¿ Run Accessibility Tests
        run: npm run test:a11y
        
      - name: ğŸ“Š Upload A11y Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-report
          path: test-results/accessibility/

  # =============================================================================
  # PERFORMANCE TESTS
  # =============================================================================
  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps
        
      - name: ğŸŒ Start Test Server
        run: |
          npm run dev &
          sleep 10
          
      - name: âš¡ Run Performance Tests
        run: npm run test:perf
        
      - name: ğŸ“Š Upload Performance Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-report
          path: test-results/performance/

  # =============================================================================
  # END-TO-END TESTS
  # =============================================================================
  e2e:
    name: ğŸ§ª End-to-End Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps ${{ matrix.browser }}
        
      - name: ğŸŒ Start Test Server
        run: |
          npm run dev &
          sleep 10
          
      - name: ğŸ§ª Run E2E Tests
        run: npx playwright test --project=${{ matrix.browser }}
        
      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-report-${{ matrix.browser }}
          path: test-results/

  # =============================================================================
  # SECURITY TESTS
  # =============================================================================
  security:
    name: ğŸ›¡ï¸ Security Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ”’ Security Audit
        run: npm audit --audit-level=moderate
        
      - name: ğŸ›¡ï¸ OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:8080'
          
      - name: ğŸ“Š Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: zap-report.html

  # =============================================================================
  # BUILD TEST
  # =============================================================================
  build:
    name: ğŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Test Build Process
        run: npm run build
        
      - name: ğŸ“Š Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/

  # =============================================================================
  # LEGAL COMPLIANCE CHECK
  # =============================================================================
  legal-check:
    name: âš–ï¸ Legal Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: âš–ï¸ Check Legal Templates
        run: |
          echo "ğŸ” Checking for placeholder replacements in legal documents..."
          
          # Check if templates still contain placeholders
          if grep -r "\[FIRMA\]\|\[EMAIL\]\|\[ANSCHRIFT\]" legal/; then
            echo "âŒ Legal templates still contain placeholders!"
            echo "Please replace all [PLACEHOLDER] values before deployment."
            exit 1
          else
            echo "âœ… Legal templates appear to be properly configured."
          fi
          
      - name: ğŸ“„ Validate Required Legal Files
        run: |
          required_files=("legal/agb.template.md" "legal/datenschutz.template.md" "legal/impressum.template.md")
          
          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "âŒ Required legal file missing: $file"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done

  # =============================================================================
  # SUMMARY JOB
  # =============================================================================
  ci-summary:
    name: ğŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [lint, accessibility, performance, e2e, security, build, legal-check]
    if: always()
    
    steps:
      - name: ğŸ“‹ Check CI Results
        run: |
          echo "## ğŸ“Š CI/CD Pipeline Results"
          echo "- Linting: ${{ needs.lint.result }}"
          echo "- Accessibility: ${{ needs.accessibility.result }}"
          echo "- Performance: ${{ needs.performance.result }}"
          echo "- E2E Tests: ${{ needs.e2e.result }}"
          echo "- Security: ${{ needs.security.result }}"
          echo "- Build: ${{ needs.build.result }}"
          echo "- Legal Check: ${{ needs.legal-check.result }}"
          
          if [[ "${{ needs.lint.result }}" == "failure" || 
                "${{ needs.accessibility.result }}" == "failure" || 
                "${{ needs.performance.result }}" == "failure" || 
                "${{ needs.e2e.result }}" == "failure" || 
                "${{ needs.security.result }}" == "failure" || 
                "${{ needs.build.result }}" == "failure" || 
                "${{ needs.legal-check.result }}" == "failure" ]]; then
            echo "âŒ Some CI checks failed!"
            exit 1
          else
            echo "âœ… All CI checks passed!"
          fi